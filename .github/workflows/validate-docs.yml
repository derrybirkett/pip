name: Validate Documentation

on:
  pull_request:
    paths:
      - '**.md'
      - 'patterns/**'
      - 'docs/**'
      - 'ia/**'
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'patterns/**'
      - 'docs/**'
      - 'ia/**'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !node_modules
            !.pip

  link-checker:
    name: Check Internal Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check links in patterns/
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: 'patterns/'
          file-extension: '.md'

      - name: Check links in docs/
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
          folder-path: 'docs/'
          file-extension: '.md'

  structure-validation:
    name: Validate Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required directories exist
        run: |
          echo "Checking directory structure..."
          
          # Core directories
          test -d "patterns/agent-workflows" || (echo "❌ Missing patterns/agent-workflows" && exit 1)
          test -d "patterns/decision-frameworks" || (echo "❌ Missing patterns/decision-frameworks" && exit 1)
          test -d "patterns/quality-metrics" || (echo "❌ Missing patterns/quality-metrics" && exit 1)
          test -d "ia/agents" || (echo "❌ Missing ia/agents" && exit 1)
          test -d "docs" || (echo "❌ Missing docs" && exit 1)
          test -d "fragments" || (echo "❌ Missing fragments" && exit 1)
          
          echo "✅ All required directories present"

      - name: Verify core documentation files exist
        run: |
          echo "Checking core documentation..."
          
          # Core files
          test -f "README.md" || (echo "❌ Missing README.md" && exit 1)
          test -f "WARP.md" || (echo "❌ Missing WARP.md" && exit 1)
          test -f "ROADMAP.md" || (echo "❌ Missing ROADMAP.md" && exit 1)
          test -f "docs/activity-log.md" || (echo "❌ Missing docs/activity-log.md" && exit 1)
          test -f "docs/changelog.md" || (echo "❌ Missing docs/changelog.md" && exit 1)
          
          echo "✅ All core documentation files present"

      - name: Check pattern references are valid
        run: |
          echo "Checking pattern cross-references..."
          
          # If patterns exist, check they reference each other correctly
          if [ -f "patterns/agent-workflows/react-pattern.md" ]; then
            # ReAct should reference Planning, Reflection, Tool Use, Multi-agent
            grep -q "planning-pattern.md" patterns/agent-workflows/react-pattern.md || \
              (echo "⚠️  ReAct pattern missing reference to Planning pattern" && exit 0)
            echo "✅ Pattern references look good"
          else
            echo "ℹ️  No patterns to check yet"
          fi

  pattern-quality:
    name: Pattern Documentation Quality
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'patterns/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check pattern completeness
        run: |
          echo "Checking pattern documentation completeness..."
          
          # Check each pattern file has required sections
          for pattern in patterns/agent-workflows/*.md; do
            if [ -f "$pattern" ]; then
              echo "Checking $pattern..."
              
              # Required sections
              grep -q "## Overview" "$pattern" || echo "⚠️  Missing Overview in $pattern"
              grep -q "## When to Use" "$pattern" || echo "⚠️  Missing 'When to Use' in $pattern"
              grep -q "## Best Practices" "$pattern" || echo "⚠️  Missing 'Best Practices' in $pattern"
              grep -q "## Related Patterns" "$pattern" || echo "⚠️  Missing 'Related Patterns' in $pattern"
            fi
          done
          
          echo "✅ Pattern quality check complete"
